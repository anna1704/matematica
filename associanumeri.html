<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Associazione Numeri in Lettere (3/4 Cifre) - Drag & Drop</title>
    <style>
        body {
            font-family: 'Verdana', sans-serif;
            background-color: #f8f9fa;
            color: #343a40;
            text-align: center;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background-color: #ffffff;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        h1 {
            color: #007bff;
            margin-bottom: 30px;
        }
        
        /* Contenitori Colonne */
        #matching-area {
            display: flex;
            justify-content: space-around;
            margin-bottom: 30px;
        }
        
        .column {
            width: 45%;
            padding: 20px;
            border-radius: 8px;
            background-color: #e9ecef;
            min-height: 400px;
        }

        /* Colonna A: Numeri in Cifre (Trascinabili) */
        #colonna-cifre {
            background-color: #ccf2ff; /* Azzurro chiaro */
            border: 2px solid #007bff;
        }
        
        .card {
            background-color: #007bff; /* Blu */
            color: white;
            padding: 15px 10px;
            margin: 15px 0;
            border-radius: 6px;
            font-size: 1.6em;
            font-weight: bold;
            cursor: grab;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            transition: opacity 0.1s;
        }

        /* Colonna B: Scrittura in Lettere (Zone di Rilascio) */
        #colonna-lettere {
            background-color: #e6ffe6; /* Verde chiaro */
            border: 2px solid #28a745;
        }

        .drop-zone {
            padding: 15px 10px;
            margin: 15px 0;
            border-radius: 6px;
            min-height: 50px;
            background-color: #f8fff8; /* Sfondo chiaro per le zone */
            border: 1px dashed #28a745;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            text-align: left;
            position: relative;
        }
        
        .drop-zone.hovered {
            background-color: #d4edda;
            border-color: #155724;
        }
        
        /* Stile per la CARD quando è posizionata nella zona */
        .drop-zone .card {
            position: absolute;
            width: 95%;
            margin: 0;
            left: 50%;
            transform: translateX(-50%);
            box-shadow: 0 0 8px rgba(0, 0, 0, 0.3);
            cursor: default;
        }

        /* Risultato e Controlli */
        .controls { margin-top: 30px; }
        
        .controls button {
            padding: 12px 25px;
            font-size: 1.1em;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin: 0 10px;
            transition: background-color 0.3s;
            font-weight: bold;
        }
        
        #check-button {
            background-color: #28a745;
            color: white;
        }

        #new-problem-button {
            background-color: #ffc107;
            color: #343a40;
        }

        .result-box {
            font-size: 1.6em;
            font-weight: bold;
            min-height: 40px;
            margin-top: 20px;
        }
        .correct { color: #28a745; }
        .incorrect { color: #dc3545; }
        
        /* Feedback Visivo */
        .correct-match { background-color: #d4edda !important; border-color: #155724 !important; }
        .incorrect-match { background-color: #f8d7da !important; border-color: #721c24 !important; }

    </style>
</head>
<body>

    <div class="container">
        <h1>Associa il Numero in Cifre alla Scrittura in Lettere</h1>
        
        <div id="matching-area">
            
            <div id="colonna-cifre" class="column">
                <h2>Cifre Trascinabili</h2>
                </div>

            <div id="colonna-lettere" class="column">
                <h2>Scrittura in Lettere (Zone di Rilascio)</h2>
                </div>

        </div>
        
        <div id="result" class="result-box"></div>

        <div class="controls">
            <button id="check-button" onclick="checkMatches()">Controlla Abbinamenti</button>
            <button id="new-problem-button" onclick="loadNewProblem()">Nuovo Esercizio</button>
        </div>
        <div id="credits">
    <p><a href="http://didatticalibera.org" target="_blank">Anna F. Leopardi</a></p>
    <p>Distribuito sotto Licenza <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/deed.it" target="_blank">Creative Commons Attribuzione - Non Commerciale - Condividi allo stesso modo 4.0 Internazionale (CC BY-NC-SA 4.0)</a></p>
</div>

<style>
/* ... il resto dei tuoi stili CSS ... */

/* Stili per la sezione Crediti */
#credits {
    margin-top: 40px; /* Spazio sopra il box */
    text-align: center; /* Centra il testo all'interno del div */
    font-size: 0.8em; /* Rende il testo piccolo */
    color: #7f8c8d; /* Un grigio leggero per i crediti */
}
</style>
    </div>

    <script>
        const DRAGGABLE_CONTAINER = document.getElementById('colonna-cifre');
        const DROP_ZONES_CONTAINER = document.getElementById('colonna-lettere');
        const RESULT_BOX = document.getElementById('result');
        
        let correctMatches = {}; 
        const NUM_PROBLEMS = 5;
        const MAX_NUMBER = 9999;
        const MIN_NUMBER = 100;
        
        // Mappatura delle cifre per la conversione
        const units = ["", "uno", "due", "tre", "quattro", "cinque", "sei", "sette", "otto", "nove"];
        const teens = ["dieci", "undici", "dodici", "tredici", "quattordici", "quindici", "sedici", "diciassette", "diciotto", "diciannove"];
        const tens = ["", "", "venti", "trenta", "quaranta", "cinquanta", "sessanta", "settanta", "ottanta", "novanta"];

        /* ------------------------------------------------ */
        /* FUNZIONI DI CONVERSIONE (NUMERO -> LETTERE) - CORRETTE E UNITE */
        /* ------------------------------------------------ */

        function convertThreeDigits(num) {
            if (num === 0) return "";
            let s = "";
            let h = Math.floor(num / 100);
            let t = num % 100;

            // Centinaia
            if (h > 0) {
                if (h === 1) {
                    s += "cento";
                } else {
                    s += units[h] + "cento";
                }
            }

            // Decine e Unità
            if (t > 0) {
                if (t < 10) {
                    s += units[t];
                } else if (t < 20) {
                    s += teens[t - 10];
                } else {
                    let d = Math.floor(t / 10);
                    let u = t % 10;
                    
                    let decineStr = tens[d];
                    
                    // Gestione del troncamento (es. ventO, trentA -> vent/trent) davanti a uno e otto
                    if ((u === 1 || u === 8) && d >= 2) {
                        decineStr = decineStr.slice(0, -1);
                    }
                    
                    s += decineStr;
                    if (u > 0) {
                        s += units[u];
                    }
                }
            }
            
            // Regole finali per unire (es. ventuno, centotto)
            s = s.replace(/ventuno$/, 'ventuno').replace(/ventotto$/, 'ventotto');
            s = s.replace(/centuno$/, 'centuno').replace(/centotto$/, 'centotto');
            
            return s.trim();
        }

        function convertNumberToItalian(num) {
            if (num === 0) return "zero";
            if (num < 100) return convertThreeDigits(num);
            
            let s = "";
            let thousands = Math.floor(num / 1000);
            let remainder = num % 1000;

            // Migliaia
            if (thousands > 0) {
                if (thousands === 1) {
                    s += "mille";
                } else {
                    s += convertThreeDigits(thousands) + "mila"; 
                }
            }

            // Centinaia/Decine/Unità
            if (remainder > 0) {
                s += convertThreeDigits(remainder);
            }
            
            // ** REGOLA ACCENTO FINALE PER 'TRE' **
            // Applica l'accento solo se la stringa termina con 'tre' e non è la parola 'tre' isolata (num !== 3)
            if (num % 10 === 3 && num !== 3) {
                s = s.replace(/tre$/, 'tré'); 
            }
            
            return s.trim();
        }


        /* ------------------------------------------------ */
        /* FUNZIONI DI INIZIALIZZAZIONE E DRAG & DROP */
        /* ------------------------------------------------ */

        function createCard(number) {
            const card = document.createElement('div');
            card.className = 'card';
            card.textContent = number;
            card.setAttribute('draggable', true);
            card.setAttribute('data-number', number);
            card.setAttribute('data-match-id', number);
            return card;
        }

        function createDropZone(text, matchId) {
            const zone = document.createElement('div');
            zone.className = 'drop-zone';
            zone.innerHTML = `<span class="lettere-text">${text}</span>`;
            zone.setAttribute('data-match-id', matchId);
            return zone;
        }

        function loadNewProblem() {
            DRAGGABLE_CONTAINER.innerHTML = '';
            DROP_ZONES_CONTAINER.innerHTML = '';
            RESULT_BOX.textContent = '';
            
            let generatedNumbers = [];
            correctMatches = {};

            // 1. Genera numeri unici e le loro scritture in lettere
            while (generatedNumbers.length < NUM_PROBLEMS) {
                const num = Math.floor(Math.random() * (MAX_NUMBER - MIN_NUMBER + 1)) + MIN_NUMBER; 
                if (!generatedNumbers.includes(num)) {
                    const text = convertNumberToItalian(num);
                    generatedNumbers.push(num);
                    correctMatches[num] = text;
                }
            }
            
            // 2. Mescola i numeri per le tessere (Colonna Cifre)
            const shuffledNumbers = shuffleArray(generatedNumbers);
            
            // 3. Mescola le scritture in lettere per le drop zones (Colonna Lettere)
            const shuffledTexts = shuffleArray(Object.values(correctMatches));
            
            // 4. Creazione delle Tessere (Cifre)
            shuffledNumbers.forEach(number => {
                const card = createCard(number);
                DRAGGABLE_CONTAINER.appendChild(card);
            });

            // 5. Creazione delle Zone di Rilascio (Lettere)
            shuffledTexts.forEach(text => {
                const matchingNumber = generatedNumbers.find(n => correctMatches[n] === text);
                const zone = createDropZone(text, matchingNumber);
                DROP_ZONES_CONTAINER.appendChild(zone);
            });

            addDragAndDropListeners();
        }

        /* ------------------------------------------------ */
        /* FUNZIONI DRAG AND DROP (Logica stabile e pulita) */
        /* ------------------------------------------------ */

        function addDragAndDropListeners() {
            const cards = document.querySelectorAll('.card');
            const dropZones = document.querySelectorAll('.drop-zone');
            let draggedCard = null;

            cards.forEach(card => {
                card.addEventListener('dragstart', (e) => {
                    draggedCard = card;
                    e.dataTransfer.setData('text/plain', card.getAttribute('data-match-id'));
                    setTimeout(() => { card.style.opacity = '0.1'; }, 0); 
                });

                card.addEventListener('dragend', (e) => {
                    if (draggedCard && draggedCard.parentNode === DRAGGABLE_CONTAINER) {
                        draggedCard.style.opacity = '1';
                    }
                });
            });

            dropZones.forEach(zone => {
                zone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    zone.classList.add('hovered');
                });

                zone.addEventListener('dragleave', () => {
                    zone.classList.remove('hovered');
                });

                zone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    zone.classList.remove('hovered');
                    
                    if (draggedCard) {
                        const existingCard = zone.querySelector('.card');
                        
                        // 1. Gestione Scambio: Riporta la vecchia carta nel contenitore di origine
                        if (existingCard) {
                            existingCard.style.opacity = '1';
                            existingCard.setAttribute('draggable', true);
                            existingCard.style.cursor = 'grab';
                            DRAGGABLE_CONTAINER.appendChild(existingCard); 
                        }

                        // 2. Rimuovi la carta trascinata dal vecchio genitore (per sicurezza)
                        if (draggedCard.parentNode) {
                            draggedCard.parentNode.removeChild(draggedCard);
                        }
                        
                        // 3. Sposta la nuova carta nella drop zone
                        draggedCard.style.opacity = '1'; 
                        draggedCard.setAttribute('draggable', false);
                        draggedCard.style.cursor = 'default';
                        
                        zone.innerHTML = ''; // Rimuove il testo in lettere
                        zone.appendChild(draggedCard);

                        // 4. Pulizia feedback
                        zone.classList.remove('correct-match', 'incorrect-match');
                        RESULT_BOX.textContent = '';
                        draggedCard = null;
                    }
                });
            });
            
            // Funzione per permettere il drag back (dal drop zone al container)
            DRAGGABLE_CONTAINER.addEventListener('drop', (e) => {
                e.preventDefault();
                if (draggedCard && draggedCard.parentNode !== DRAGGABLE_CONTAINER && draggedCard.parentNode.classList.contains('drop-zone')) {
                    const oldZone = draggedCard.parentNode;
                    
                    // Riabilita la zona (ripristina il testo in lettere)
                    const zoneMatchId = oldZone.getAttribute('data-match-id');
                    const matchText = correctMatches[zoneMatchId]; 
                    
                    oldZone.innerHTML = `<span class="lettere-text">${matchText}</span>`;
                    
                    // Sposta la carta nel contenitore drag
                    DRAGGABLE_CONTAINER.appendChild(draggedCard);
                    draggedCard.style.opacity = '1';
                    draggedCard.setAttribute('draggable', true);
                    draggedCard.style.cursor = 'grab';
                    
                    // Pulizia feedback
                    oldZone.classList.remove('correct-match', 'incorrect-match');
                    RESULT_BOX.textContent = '';
                    draggedCard = null;
                }
            });

            DRAGGABLE_CONTAINER.addEventListener('dragover', (e) => {
                e.preventDefault();
            });
        }


        /* ------------------------------------------------ */
        /* FUNZIONI DI CONTROLLO */
        /* ------------------------------------------------ */

        function checkMatches() {
            const dropZones = document.querySelectorAll('.drop-zone');
            let allMatched = true;
            let correctCount = 0;

            dropZones.forEach(zone => {
                const card = zone.querySelector('.card');
                zone.classList.remove('correct-match', 'incorrect-match');
                
                if (card) {
                    const cardId = card.getAttribute('data-match-id');
                    const zoneId = zone.getAttribute('data-match-id');
                    
                    if (cardId === zoneId) {
                        zone.classList.add('correct-match');
                        correctCount++;
                    } else {
                        zone.classList.add('incorrect-match');
                    }
                } else {
                    allMatched = false;
                }
            });

            if (!allMatched) {
                RESULT_BOX.innerHTML = "❌ Devi abbinare tutti i numeri prima di controllare!";
                RESULT_BOX.className = 'result-box incorrect';
            } else if (correctCount === NUM_PROBLEMS) {
                RESULT_BOX.innerHTML = `🎉 Complimenti! Tutti e ${NUM_PROBLEMS} gli abbinamenti sono corretti!`;
                RESULT_BOX.className = 'result-box correct';
            } else {
                RESULT_BOX.innerHTML = `❌ ${correctCount} su ${NUM_PROBLEMS} corretti. Riprova!`;
                RESULT_BOX.className = 'result-box incorrect';
            }
        }

        // Funzione helper per mescolare gli array
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }


        // Carica il primo esercizio all'avvio della pagina
        document.addEventListener('DOMContentLoaded', loadNewProblem);

    </script>

</body>
</html>
